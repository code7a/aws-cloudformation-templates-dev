{
    "Mappings":{
        "RegionMap":{
            "us-east-1":{"AlmaLinuxOS9320231116x8664":"ami-07bc349330a94a4e3"},
            "us-west-2":{"AlmaLinuxOS9320231116x8664":"ami-06d994e3bcde26f6c"}
        }
    },
    "Resources":{
        "Bucket":{
            "Type":"AWS::S3::Bucket"
        },
        "InternetGateway":{
            "Type":"AWS::EC2::InternetGateway"
        },
        "VPC":{
            "Type":"AWS::EC2::VPC",
            "Properties":{
                "CidrBlock":"10.0.0.0/16",
                "EnableDnsHostnames":"true"
            },
            "DependsOn":"InternetGateway"
        },
        "FlowLog":{
            "Type":"AWS::EC2::FlowLog",
            "Properties":{
                "LogDestination":{"Fn::Join":["",["arn:aws:s3:::",{"Ref":"Bucket"}]]},
                "LogDestinationType":"s3",
                "ResourceId":{"Ref":"VPC"},
                "ResourceType":"VPC",
                "TrafficType":"ALL"
            },
            "DependsOn":["Bucket","VPC"]
        },
        "VPCGatewayAttachment":{
            "Type":"AWS::EC2::VPCGatewayAttachment",
            "Properties":{
                "InternetGatewayId":{"Ref":"InternetGateway"},
                "VpcId":{"Ref":"VPC"}
            },
            "DependsOn":"VPC"
        },
        "RouteTable":{
            "Type":"AWS::EC2::RouteTable",
            "Properties":{
                "VpcId":{"Ref":"VPC"}
            },
            "DependsOn":"VPCGatewayAttachment"
        },
        "Route":{
            "Type":"AWS::EC2::Route",
            "Properties":{
                "DestinationCidrBlock":"0.0.0.0/0",
                "GatewayId":{"Ref":"InternetGateway"},
                "RouteTableId":{"Ref":"RouteTable"}
            },
            "DependsOn":"RouteTable"
        },
        "SubnetA":{
            "Type":"AWS::EC2::Subnet",
            "Properties":{
                "CidrBlock":"10.0.0.0/20",
                "AvailabilityZone":{"Fn::Join":["",[{"Ref":"AWS::Region"},"a"]]},
                "MapPublicIpOnLaunch":"true",
                "VpcId":{"Ref":"VPC"}
            },
            "DependsOn":"VPC"
        },
        "SubnetB":{
            "Type":"AWS::EC2::Subnet",
            "Properties":{
                "CidrBlock":"10.0.16.0/20",
                "AvailabilityZone":{"Fn::Join":["",[{"Ref":"AWS::Region"},"b"]]},
                "MapPublicIpOnLaunch":"true",
                "VpcId":{"Ref":"VPC"}
            },
            "DependsOn":"SubnetA"
        },
        "SubnetARouteTableAssociation":{
            "Type":"AWS::EC2::SubnetRouteTableAssociation",
            "Properties":{
                "RouteTableId":{"Ref":"RouteTable"},
                "SubnetId":{"Ref":"SubnetA"}
            },
            "DependsOn":"SubnetA"
        },
        "SubnetBRouteTableAssociation":{
            "Type":"AWS::EC2::SubnetRouteTableAssociation",
            "Properties":{
                "RouteTableId":{"Ref":"RouteTable"},
                "SubnetId":{"Ref":"SubnetB"}
            },
            "DependsOn":"SubnetB"
        },
        "KeyPair":{
            "Type":"AWS::EC2::KeyPair",
            "Properties":{
                "KeyName":{"Ref":"AWS::StackName"},
                "PublicKeyMaterial":"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCQ4VU2GCR4WvjrX/rQ2NFVcbHHKXb69Hsx4NKbZkcnubte4UGBGmzLF9dCkrjYIHM/l/+XY1Hxv7AyLP8ou3YL0wAkuStSaioqf0n8oVDDz0spB3oJI2fGH++t72d7LGzKXlp3ZCVmv7HHuUrbVnegff1b+hSrZTwvLnNVr29MuqWiHxEpfQhYmyadl3HTVPrDJdgmLl+PjPneZnXEQyhYxVRyxIHkdm3fKT0fDzH9CvEhfKSWuy/pra/RVoknfKiCYsKPsDkfddeBvw/4zadbr1kXunvVl7maI/1Lf12bhlncVRzozoL76H338O8vMTt5YHcPCaZraWRJvj1/Hig22mhrZPmYnmGkG+pc8eL4q4ErgXF6xDyPI6Aol2MsphX3zQ63JrvAFynrkkmjxO3AG70zhuDs+zp7mLpZ+jrUc/Mo45Y4ZVOQ7304DNRgAoQkL4MsTXH3D6EosbMi3pf1Dniar8hQnU8G/uM0P7+40n9Bs5OSP+fNIeJ+z0ntKVU="
            }
        },
        "SecurityGroup":{
            "Type":"AWS::EC2::SecurityGroup",
            "Properties":{
                "GroupDescription":{"Ref":"AWS::StackName"},
                "GroupName":{"Ref":"AWS::StackName"},
                "SecurityGroupIngress":[{"IpProtocol":"-1","CidrIp":"0.0.0.0/0"}],
                "VpcId":{"Ref":"VPC"}
            },
            "DependsOn":"SubnetBRouteTableAssociation"
        },
        "DBSubnetGroup":{
            "Type":"AWS::RDS::DBSubnetGroup",
            "Properties":{
                "DBSubnetGroupDescription":{"Fn::Join":["",[{"Ref":"AWS::StackName"},"-alfa-db_subnet_group"]]},
                "DBSubnetGroupName":{"Fn::Join":["",[{"Ref":"AWS::StackName"},"-alfa-db_subnet_group"]]},
                "SubnetIds":[{"Ref":"SubnetA"},{"Ref":"SubnetB"}]
            },
            "DependsOn":"SubnetBRouteTableAssociation"
        },
        "DBInstance":{
            "Type":"AWS::RDS::DBInstance",
            "Properties":{
                "AllocatedStorage":"20",
                "DBInstanceClass":"db.t4g.micro",
                "DBInstanceIdentifier":{"Fn::Join":["",[{"Ref":"AWS::StackName"},"-alfa-db"]]},
                "DBName":"DBName",
                "DBSubnetGroupName":{"Ref":"DBSubnetGroup"},
                "Engine":"mysql",
                "MasterUsername":"admin",
                "MasterUserPassword":"21232f297a57a5a743894a0e4a801fc3",
                "VPCSecurityGroups":[{"Ref":"SecurityGroup"}],
                "Tags":[
                    {"Key":"App","Value":"alfa"},
                    {"Key":"Role","Value":"db"}
                ]
            },
            "DependsOn":"DBSubnetGroup"
        },
        "InstanceApp":{
            "Type":"AWS::EC2::Instance",
            "Properties":{
                "ImageId":{"Fn::FindInMap":["RegionMap",{"Ref":"AWS::Region"},"AlmaLinuxOS9320231116x8664"]},
                "InstanceType":"t3a.micro",
                "KeyName":{"Ref":"AWS::StackName"},
                "SecurityGroupIds":[{"Ref":"SecurityGroup"}],
                "SubnetId":{"Ref":"SubnetA"},
                "Tags":[
                    {"Key":"Name","Value":{"Fn::Join":["",[{"Ref":"AWS::StackName"},"-alfa-app"]]}},
                    {"Key":"App","Value":"alfa"},
                    {"Key":"Role","Value":"app"}
                ],
                "UserData":{"Fn::Base64":{"Fn::Sub":"#!/bin/bash\nyum install -y mysql\ncat <<EOF | tee create_database.sql\ncreate database alfa_database;\nuse alfa_database;\ncreate table alfa_table (id int not null auto_increment,timestamp timestamp default current_timestamp,timestamp_md5 char(32),primary key (id));\nEOF\nmysql -h ${DBInstance.Endpoint.Address} -P 3306 -u admin -p21232f297a57a5a743894a0e4a801fc3 < create_database.sql\ncat <<EOF | tee mysql_insert.sh\ninsert_statement=\"insert into alfa_table values (default,default,'\\$(date|md5sum|cut -d' ' -f1)');\"\nmysql -h ${DBInstance.Endpoint.Address} -P 3306 -D alfa_database -u admin -p21232f297a57a5a743894a0e4a801fc3 -e \"\\$insert_statement\"\nEOF\nchmod +x mysql_insert.sh\necho '* * * * * root /mysql_insert.sh >/dev/null 2>&1' > /etc/cron.d/mysql_insert"}}
            },
            "DependsOn":"DBInstance"
        },
        "InstanceWeb":{
            "Type":"AWS::EC2::Instance",
            "Properties":{
                "ImageId":{"Fn::FindInMap":["RegionMap",{"Ref":"AWS::Region"},"AlmaLinuxOS9320231116x8664"]},
                "InstanceType":"t3a.micro",
                "KeyName":{"Ref":"AWS::StackName"},
                "SecurityGroupIds":[{"Ref":"SecurityGroup"}],
                "SubnetId":{"Ref":"SubnetB"},
                "Tags":[
                    {"Key":"Name","Value":{"Fn::Join":["",[{"Ref":"AWS::StackName"},"-alfa-web"]]}},
                    {"Key":"App","Value":"alfa"},
                    {"Key":"Role","Value":"web"}
                ],
                "UserData":{"Fn::Base64":{"Fn::Sub":"#!/bin/bash\nyum install -y mysql nginx\nsystemctl enable nginx\nsystemctl start nginx\ncat <<EOF | tee /mysql_dump.sh\nmysql -h ${DBInstance.Endpoint.Address} -u admin -p21232f297a57a5a743894a0e4a801fc3 -D alfa_database -P 3306 -e \"select * from alfa_table order by id desc limit 10;\" > /usr/share/nginx/html/mysql_dump.txt\nEOF\nchmod +x /mysql_dump.sh\necho '* * * * * root /mysql_dump.sh >/dev/null 2>&1' > /etc/cron.d/mysql_dump"}}
            },
            "DependsOn":"DBInstance"
        }
    }
}